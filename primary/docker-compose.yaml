services:
  caddy:
    build: ./dockerfile-caddy
    container_name: caddy
    hostname: caddy
    restart: always
    networks:
      dhcp-network:
        ipv4_address: ${CADDY_SERVER_IP}
    ports:
      - "443:443"
    environment:
      - MY_DOMAIN
      - CLOUDFLARE_API_TOKEN
      - DHCPv4_SERVER_IP
    volumes:
      - ../kea-data/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../kea-data/caddy_data:/data
      - ../kea-data/caddy_config:/config

  kea-dhcp4-primary:
    container_name: kea-dhcp4-primary
    image: docker.cloudsmith.io/isc/docker/kea-dhcp4:${KEA_VERSION}
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE
      - NET_RAW
    restart: always
    networks:
      dhcp-network:
        ipv4_address: ${DHCPv4_SERVER_IP}
    dns:
      - 10.10.10.10
      - 10.10.10.11
    volumes:
      - "./leases:/var/lib/kea"
      - "./config/kea-dhcp4.conf:/etc/kea/kea-dhcp4.conf:ro"
      - "../kea-data/ha-peers-primary.json:/etc/kea/ha-peers-primary.json:ro"
      - "../kea-data/subnet-id1.json:/etc/kea/subnet-id1.json:ro"
      - "../kea-data/subnet-id2.json:/etc/kea/subnet-id2.json:ro"
      - "../kea-data/subnet-id3.json:/etc/kea/subnet-id3.json:ro"
      - "../kea-data/server.crt:/etc/kea/server.crt:ro"
      - "../kea-data/server.key:/etc/kea/server.key:ro"
    ports:
      - "67:67/udp"
      - "8001:8001"

  kea-ddns-primary:
    container_name: kea-ddns-primary
    image: docker.cloudsmith.io/isc/docker/kea-dhcp-ddns:${KEA_VERSION}
    depends_on:
      - kea-dhcp4-primary
    restart: always
    networks:
      dhcp-network:
        ipv4_address: ${DDNS_SERVER_IP}
    dns:
      - 10.10.10.10
      - 10.10.10.11
    volumes:
      - "./config/kea-dhcp-ddns.conf:/etc/kea/kea-dhcp-ddns.conf:ro"
      - "../kea-data/tsig-keys.json:/etc/kea/tsig-keys.json:ro"
      - "../kea-data/forward-ddns.json:/etc/kea/forward-ddns.json:ro"
      - "../kea-data/reverse-ddns.json:/etc/kea/reverse-ddns.json:ro"

networks:
  dhcp-network:
    driver: bridge
    ipam: 
      config:
        - subnet: ${NETWORK_CIDR}
